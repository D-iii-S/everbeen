<!DOCTYPE html>

<html t:type="layout" section="section"
      xmlns:t="http://tapestry.apache.org/schema/tapestry_5_3.xsd" xmlns:p="tapestry:parameter">

    <h2>Benchmark &amp; Task Tree</h2>

    <div style="float: right; text-align: right;">
        <t:if t:test="swRepositoryOnline">
            <button class="btn btn-primary" onclick="location.href='/task/submit'; return false;">Submit new item
            </button>
            <p:else>
                <span class="text-warning">Software repository disconnected. Can't submit any new item.</span>
            </p:else>
        </t:if>
        <br/>
        <br/>
        <t:actionLink class="btn btn-warning" t:id="removeAllFinishedBenchmarks"
                      onclick="if (window.confirm('Are you sure?')) location.href=jQuery(this).attr('href'); return false;">
            Remove finished benchmarks
        </t:actionLink>
    </div>

    <table class="list">
        <thead>
            <tr>
                <th>Benchmark ID</th>
                <th>Name</th>
                <th>Generator task</th>
                <th>State</th>
                <th>Generated</th>
                <th>Resubmits</th>
                <th></th>
            </tr>
        </thead>

        <t:loop source="benchmarks" value="benchmark">
            <tr style="background-color: #eee;">
                <td>
                    <i class="icon-rocket"></i>&nbsp;
                    <a href="/benchmark/detail/${benchmark.id}">
                        <t:output format="idFormat" value="benchmark.id"/>
                    </a>
                </td>
                <td>
                    ${benchmarkName(benchmark.id)}
                </td>
                <td>
                    <i class="icon-beaker"></i>&nbsp;
                    <a href="/task/detail/${benchmark.generatorId}">
                        <t:output format="idFormat" value="benchmark.generatorId"/>
                    </a>
                </td>
                <td>
                    <t:outputRaw value="taskStateWithIcon(benchmarkState(benchmark.id))"/>
                </td>
                <td>
                    ${benchmark.generatedContextCount}
                </td>
                <td>
                    ${benchmark.resubmitHistory.resubmitHistoryItem.size()}
                </td>
                <td>
                    <t:if test="benchmarkInFinalState(benchmark.id)">
                        <t:if test="isBenchmarkRemovable(benchmark)">
                            <t:actionLink class="btn btn-mini btn-warning" t:id="removeBenchmark"
                                          t:context="benchmark.id"
                                          onclick="if (window.confirm('Are you sure?')) location.href=jQuery(this).attr('href'); return false;">
                                Remove
                            </t:actionLink>
                        </t:if>
                        <p:else>
                            <t:actionLink class="btn btn-mini btn-danger" t:id="killBenchmark" t:context="benchmark.id"
                                          onclick="if (window.confirm('Are you sure?')) location.href=jQuery(this).attr('href'); return false;">
                                Kill
                            </t:actionLink>
                        </p:else>
                    </t:if>

                </td>
            </tr>

            <tr>
                <td></td>
                <td colspan="6">
                    <table>
                        <tr>
                            <th>Context ID</th>
                            <th>Name</th>
                            <th>State</th>
                            <th>Tasks</th>
                            <th></th>
                        </tr>
                        <t:loop source="contextsForBenchmark(benchmark.id)" value="context">
                            <tr>
                                <td>
                                    <i class="icon-book"></i>&nbsp;
                                    <a href="/context/detail/${context.id}">
                                        <t:output format="idFormat" value="context.id"/>
                                    </a>
                                </td>
                                <td>
                                    ${context.taskContextDescriptor.name}
                                </td>
                                <td>
                                    <t:outputRaw value="contextStateWithIcon(context.contextState)"/>
                                </td>
                                <td>
                                    <b>${context.containedTask.size()}</b>
                                    &nbsp;
                                    <a class="btn btn-mini tasktogglebutton" style="vertical-align: baseline;" href="#">
                                        <i class="icon-plus"></i>
                                    </a>
                                </td>
                                <td style="display: none;">
                                    <table class="inner-task-list">
                                        <t:loop source="tasksForContext(context.id)" value="task">
                                            <tr>
                                                <td><i class="icon-beaker"></i>&nbsp;
                                                    <a href="/task/detail/${task.id}">
                                                        <t:output format="idFormat" value="task.id"/>
                                                    </a>
                                                </td>
                                                <td>${task.taskDescriptor.name}</td>
                                                <td>
                                                    <t:outputRaw value="taskStateWithIcon(task.state)"/>
                                                </td>
                                            </tr>
                                        </t:loop>
                                    </table>
                                </td>
                            </tr>
                            <p:empty>
                                <tr>
                                    <td colspan="4">
                                        <i class="icon-info-sign"></i>
                                        There are no task contexts in this benchmark.
                                    </td>
                                </tr>
                            </p:empty>
                        </t:loop>
                    </table>
                </td>
            </tr>
            <p:empty>
                <tr>
                    <td colspan="7">
                        <i class="icon-info-sign"></i>
                        There are no benchmarks.
                    </td>
                </tr>
            </p:empty>
        </t:loop>
    </table>

    <h2 style="clear: both; padding: 40px 0 0 0;">Orphaned tasks</h2>

    <table class="list wide">
        <thead>
            <tr>
                <th>Context ID</th>
                <th>Task ID</th>
                <th>Name</th>
                <th>State</th>
            </tr>
        </thead>

        <t:loop source="orphanedContexts" value="orphanedContext">
            <t:loop source="orphanedContext" value="task" index="taskIndex">
                <tr>
                    <td>
                        <t:if test="isFirstInContext()">
                            <i class="icon-book"></i>&nbsp;
                            <a href="/context/detail/${task.taskContextId}">
                                <t:output format="idFormat" value="task.taskContextId"/>
                            </a>
                        </t:if>
                    </td>
                    <td>
                        <t:if test="taskBenchmark(task)">
                            <i class="icon-rocket"></i>
                            <p:else>
                                <i class="icon-beaker"></i>
                            </p:else>
                        </t:if>
                        &nbsp;
                        <a href="/task/detail/${task.id}">
                            <t:output format="idFormat" value="task.id"/>
                        </a>
                    </td>
                    <td>${task.taskDescriptor.name}</td>
                    <td>
                        <t:outputRaw value="taskStateWithIcon(task.state)"/>
                    </td>
                </tr>
            </t:loop>

            <p:empty>
                <tr>
                    <td colspan="5">
                        <i class="icon-info-sign"></i>
                        There are no orphaned tasks.
                    </td>
                </tr>
            </p:empty>
        </t:loop>
    </table>

</html>
